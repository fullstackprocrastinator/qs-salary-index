<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Insights – The QS Salary Index</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon" />
  <style>
    .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
    .hero { text-align: center; padding: 3rem 0; }
    .hero h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .hero p { color: #4b5563; font-size: 1.1rem; }
    .stats-grid { display: grid; grid-template-columns: repeat/auto-fit, minmax(200px, 1fr); gap: 1.5rem; margin: 2rem 0; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
    .stat-label { font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #1e40af; }
    .outliers { font-size: 0.85rem; color: #dc2626; margin-top: 0.5rem; }
    .loading { text-align: center; padding: 3rem; color: #6b7280; }
    .error { color: #dc2626; text-align: center; padding: 2rem; background: #fef2f2; border-radius: 8px; margin: 1rem 0; }
    .chart-container { max-width: 800px; margin: 2rem auto; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="container header-flex">
      <a href="/" class="logo-link">
        <img src="assets/img/qs-salary-index-logo.png" alt="The QS Salary Index Logo" class="logo">
        <span class="sr-only">The QS Salary Index</span>
      </a>
      <div class="header-text">
        <p>Live global salary data for Quantity Surveyors</p>
        <p class="brand-link">
          Part of <a href="https://www.theqscollection.com" target="_blank" rel="noopener">The QS Collection</a>
        </p>
        <nav>
          <a href="/">Index</a> |
          <a href="submit.html">Submit</a> |
          <a href="insights.html">Insights</a> |
          <a href="#" onclick="openEmail()">Contact</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container">
    <section class="hero">
      <h1>QS Salary Insights</h1>
      <p>Real-time, verified, and statistically robust data from Quantity Surveyors worldwide.</p>
    </section>

    <div id="loading" class="loading">Loading live data...</div>
    <div id="error" class="error" style="display:none;"></div>
    <div id="dashboard" style="display:none;"></div>

    <!-- CHART -->
    <div id="chartSection" class="chart-container" style="display:none;">
      <canvas id="salaryChart"></canvas>
      <p style="text-align:center; font-size:0.85rem; color:#6b7280; margin-top:1rem;" id="chartNote">
        Box = 25th–75th percentile | Whiskers = 1.5×IQR | Red dots = Outliers
      </p>
    </div>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="container">
      <p>
        &copy; 2025 The QS Salary Index. 
        <a href="privacy.html">Privacy</a> | 
        <a href="terms.html">Terms</a> | 
        Part of <a href="https://www.theqscollection.com" target="_blank" rel="noopener">The QS Collection</a>
      </p>
    </div>
  </footer>

  <!-- CHART.JS + BOXPLOT -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@3.0.0/build/chartjs-chart-box-and-violin-plot.min.js"></script>

  <script>
    const DATA_URL = 'assets/data/salaries.json';

    function parseSalary(range) {
      if (!range) return 0;
      const nums = range.replace(/[^0-9-]/g, '').split('-').map(Number).filter(n => n);
      return nums.length === 2 ? (nums[0] + nums[1]) / 2 : (nums[0] || 0);
    }

    function enhanceInsights(data) {
      if (!data || data.length === 0) return null;
      const salaries = data.map(s => parseSalary(s.salary)).filter(n => n > 0);
      if (salaries.length === 0) return null;

      const sorted = [...salaries].sort((a, b) => a - b);
      const n = sorted.length;
      const median = sorted[Math.floor(n * 0.5)];
      const p10 = sorted[Math.floor(n * 0.1)];
      const p90 = sorted[Math.floor(n * 0.9)];

      const now = new Date();
      const sixMonthsAgo = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
      const recent = data.filter(s => s.submittedAt && new Date(s.submittedAt) > sixMonthsAgo);
      const recentSalaries = recent.map(s => parseSalary(s.salary)).filter(n => n > 0);
      const totalWeight = n + recentSalaries.length;
      const weightedSum = salaries.reduce((a, b) => a + b, 0) + recentSalaries.reduce((a, b) => a + b, 0);
      const weightedAvg = totalWeight > 0 ? weightedSum / totalWeight : 0;

      const q1 = sorted[Math.floor(n * 0.25)];
      const q3 = sorted[Math.floor(n * 0.75)];
      const iqr = q3 - q1;
      const lower = q1 - 1.5 * iqr;
      const upper = q3 + 1.5 * iqr;
      const outliers = salaries.filter(s => s < lower || s > upper);

      return { median, p10, p90, sampleSize: n, weightedAvg, q1, q3, lower, upper, outliers };
    }

    function renderDashboard(insights) {
      const el = document.getElementById('dashboard');
      el.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Median Salary</div>
            <div class="stat-value">£${insights.median.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">10th–90th Percentile</div>
            <div class="stat-value">£${insights.p10.toLocaleString()} – £${insights.p90.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Sample Size</div>
            <div class="stat-value">${insights.sampleSize}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Recency-Weighted Avg</div>
            <div class="stat-value">£${Math.round(insights.weightedAvg).toLocaleString()}</div>
            <div class="outliers">${insights.outliers.length} outlier${insights.outliers.length !== 1 ? 's' : ''} flagged</div>
          </div>
        </div>
        <p style="text-align:center; color:#6b7280; font-size:0.9rem; margin-top:1rem;">
          Updated <span id="lastUpdate"></span> • <a href="submit.html">Submit yours</a>
        </p>
      `;
      document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('en-GB');
      el.style.display = 'block';
    }

    function renderBoxPlot(insights) {
      const canvas = document.getElementById('salaryChart');
      const ctx = canvas.getContext('2d');

      // FIXED: Only destroy if valid Chart instance
      if (window.salaryChart && typeof window.salaryChart.destroy === 'function') {
        window.salaryChart.destroy();
      }
      window.salaryChart = null; // Reset

      try {
        window.salaryChart = new Chart(ctx, {
          type: 'boxplot',
          data: {
            labels: ['QS Salaries (GBP)'],
            datasets: [{
              label: 'Distribution',
              data: [{
                min: insights.lower,
                q1: insights.q1,
                median: insights.median,
                q3: insights.q3,
                max: insights.upper,
                outliers: insights.outliers
              }],
              backgroundColor: 'rgba(30, 64, 175, 0.1)',
              borderColor: '#1e40af',
              borderWidth: 2,
              outlierColor: '#dc2626',
              outlierRadius: 5
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Salary Distribution', font: { size: 16, weight: 'bold' } },
              legend: { display: false }
            },
            scales: {
              x: { display: false },
              y: { title: { display: true, text: 'Salary (GBP)' }, ticks: { callback: v => '£' + v.toLocaleString() } }
            }
          }
        });
        document.getElementById('chartSection').style.display = 'block';
      } catch (e) {
        console.error("Boxplot failed:", e);
        document.getElementById('chartNote').textContent = 'Boxplot failed — check console.';
      }
    }

    async function loadData() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');

      try {
        loadingEl.textContent = 'Fetching data...';
        const res = await fetch(`${DATA_URL}?t=${Date.now()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        loadingEl.textContent = 'Parsing JSON...';
        let data = await res.json();
        if (!Array.isArray(data)) {
          if (typeof data === 'object') data = Object.values(data);
          else throw new Error('Invalid format');
        }
        if (data.length === 0) throw new Error('No entries');

        const insights = enhanceInsights(data);
        if (!insights) throw new Error('No valid salary data');

        loadingEl.style.display = 'none';
        renderDashboard(insights);
        renderBoxPlot(insights);

      } catch (err) {
        loadingEl.style.display = 'none';
        errorEl.innerHTML = `
          <strong>Live data unavailable:</strong> ${err.message}<br>
          <small>Ensure <code>assets/data/salaries.json</code> is valid JSON array with "salary" fields.</small>
        `;
        errorEl.style.display = 'block';
      }
    }

    function openEmail() {
      window.location.href = 'mailto:theqssalaryindex@outlook.com?subject=Insights%20Error';
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
